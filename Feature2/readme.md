#  Semantic Test Case Generation

A tool to assist in **analyzing code changes, mapping them to high-level features**, and **automatically generating BDD-style test scenarios** using LLMs such as Gemini.

---

## Module Overview

### `get_diff.py`
Fetches Git differences between two commits.

- **Purpose**:
  - Clone a target GitHub repository.
  - Compute `git diff` between two specified commits.
  - Optionally retain the cloned repository.
- **API**:
  ```python
  get_git_diff(repo_url: str, from_commit: str, to_commit: str, keep_repo: bool) -> str
  ```
- **Notes**:
  - The diff result is returned as a raw string for diff_mapper.py.
  - The repository is cloned into a temporary directory unless `--keep` is specified.

---

### `diff_mapper.py`
Maps natural language feature descriptions to relevant code diff chunks using Gemini API(or other LLM).

- **Purpose**:
  - Accepts a list of feature descriptions and a Git diff string.
  - Uses Gemini LLM to associate diff chunks with features.
- **API**:
  ```python
  map_diff_to_features(description_list: str, diff_content: str, api_key: str) -> dict
  ```
- **Output Format (JSON)**:
  ```json
  {
    "result": [
      {
        "feature": "Users can download TWSE financial PDFs.",
        "related_chunk": ["chunk1", "chunk2"]
      },
      ...
    ]
  }
  ```

---

### `test_plan_generator.py`
Generates BDD-style test scenarios (e.g., in Gherkin syntax) based on feature-diff mappings.

- **Purpose**:
  - Uses Gemini to generate human-readable test cases from mapped diff chunks.
- **API**:
  ```python
  generate_test_plan(feature_diff_map: dict[str, list[dict]], api_key: str) -> list
  ```
- **Output Format (JSON)**:
  ```json
  [
    {
      "feature": "Feature Name",
      "bdd_style_descriptions": [
        {
          "Scenario": "...",
          "Given": "...",
          "And": "...",
          "When": "...",
          "Then": "..."
        }
      ]
    },
    ...
  ]
  ```

---

### `main.py`
A CLI script that orchestrates the entire pipeline from git repo to BDD test plan.

- **Functionality**:
  - Retrieves Git diff.
  - Loads feature descriptions from a `.txt` file.
  - Maps features to diff chunks using Gemini.
  - Generates and saves the final BDD-style test plan.
- **Usage**:
  ```bash
  python main.py <repo_url> \
    --from COMMIT \
    --to COMMIT \
    --description_file features.txt \
    --api_key YOUR_API_KEY
  ```
- **Parameters**:

  | Argument              | Description                                 | Default   |
  |-----------------------|---------------------------------------------|-----------|
  | `<repo_url>`          | URL of the GitHub repository                | Required  |
  | `--from`              | Base commit hash                            | `HEAD^`   |
  | `--to`                | Target commit hash                          | `HEAD`    |
  | `--keep`              | Keep the cloned repo after diff             | `False`   |
  | `--description_file`  | Path to a `.txt` file containing descriptions | Required |
  | `--api_key`           | Your Gemini API key                         | Required  |

---

## Usage Example

1. Prepare a `features_description.txt` file:

    ```txt
    1. Users can download TWSE financial PDF reports.
    2. Files are saved to a specified output folder.
    3. Headless mode can be enabled to avoid showing a browser.
    ```

2. Run the CLI:

    ```bash
    python main.py https://github.com/your-org/your-repo.git \
      --from abc123 \
      --to def456 \
      --description_file features_description.txt \
      --api_key api_key
    ```

3. Output files:

    - `test_plan.json`: BDD-style test descriptions

    Here is a sample output (`test_plan.json`) generated by this tool:

```json
[
  {
    "feature": "Automatically open the TWSE announcement page",
    "bdd_style_descriptions": [
      {
        "Scenario": "Successfully opens TWSE announcement page for a specific company and year",
        "Given": "The user specifies a valid company ID and year",
        "And": "Selenium WebDriver is initialized and ready",
        "When": "The program navigates to the TWSE announcement page using Selenium",
        "Then": "The page should successfully load and show the reports for that company and year"
      }
    ]
  },
  {
    "feature": "Download company financial PDF",
    "bdd_style_descriptions": [
      {
        "Scenario": "Successfully downloads financial PDF for a specific company and year",
        "Given": "I have a valid TWSE company ID \"{company_id}\" and a valid ROC year \"{year}\"",
        "And": "TWSE provides PDF links for that company/year",
        "When": "I run the script with \"{company_id}\", \"{year}\" and specify \"{output_dir}\"",
        "Then": "The PDF should be downloaded into the specified directory"
      }
    ]
  },
  {
    "feature": "Handle popup windows",
    "bdd_style_descriptions": [
      {
        "Scenario": "Successfully handles a popup and returns to the main window",
        "Given": "User is on a page that opens a popup window",
        "And": "There is a link that triggers the popup",
        "When": "User clicks the link, interacts with the popup, and closes it",
        "Then": "System should switch back to the main window successfully"
      }
    ]
  },
  {
    "feature": "Support headless mode",
    "bdd_style_descriptions": [
      {
        "Scenario": "Script runs in default headless mode",
        "Given": "User runs the script without --no-headless",
        "And": "A valid company ID and year are provided",
        "When": "The script starts the PDF download process",
        "Then": "No browser window should be shown"
      },
      {
        "Scenario": "Script runs with --no-headless enabled",
        "Given": "User runs the script with the --no-headless flag",
        "And": "A valid company ID and year are provided",
        "When": "The script starts the PDF download process",
        "Then": "A browser window should be visible"
      }
    ]
  },
  {
    "feature": "Specify custom download folder",
    "bdd_style_descriptions": [
      {
        "Scenario": "Use --output to define custom directory",
        "Given": "twse_pdf_scraper.py is available",
        "And": "Valid company ID and year with available PDFs on TWSE site",
        "When": "User runs the script with --co_id, --year and a custom --output folder",
        "Then": "The folder should be created if it doesn't exist"
      },
      {
        "Scenario": "PDFs are downloaded to specified folder",
        "Given": "twse_pdf_scraper.py ran successfully with a custom --output folder",
        "And": "No errors occurred during execution",
        "When": "The script finishes execution",
        "Then": "PDFs should be in the specified output folder"
      }
    ]
  }
]

---
